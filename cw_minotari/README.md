# cw_minotari

Minotari (Tari) wallet integration for Cake Wallet.

## Architecture

This package integrates Minotari (XTM) support into Cake Wallet using a Rust FFI wrapper around the minotari-cli library.

### Components

1. **Rust FFI Layer** (`rust/`)
   - Wraps minotari-cli functionality
   - Exposes C-compatible API for Dart FFI
   - Handles wallet creation, restoration, balance, and transactions

2. **Dart Layer** (`lib/`)
   - FFI bindings generated by `ffigen`
   - Wallet implementation following Cake Wallet patterns
   - MobX state management
   - Hive database persistence

### Current Status

This is a work-in-progress integration. The basic structure is in place, but several components need implementation:

#### Completed

- ✅ Basic package structure
- ✅ Rust FFI skeleton with placeholder implementations
- ✅ Dart wallet classes (MinotariWallet, MinotariWalletService, etc.)
- ✅ FFI interface layer
- ✅ Balance and transaction history models

#### TODO

**Rust Layer:**
1. Add actual minotari-cli dependencies to `Cargo.toml`
2. Implement `wallet::MinotariWallet::from_mnemonic()`:
   - Parse BIP39 mnemonic
   - Derive view key and spend key (see CreateAddress in minotari-cli main.rs:221-228)
   - Call `init_with_view_key()` (see main.rs:595-611)
3. Implement `wallet::MinotariWallet::get_balance()`:
   - Follow pattern from minotari-cli main.rs:426-443
4. Implement `wallet::MinotariWallet::get_address()`:
   - Generate base58-encoded Tari address from keys
5. Implement `wallet::MinotariWallet::sync()`:
   - Connect to base node
   - Sync transaction outputs
6. Add transaction sending functionality
7. Add transaction history retrieval

**Dart Layer:**
1. Generate FFI bindings:
   ```bash
   cd cw_minotari
   cargo build --release
   flutter pub run ffigen
   ```
2. Implement BIP39 mnemonic generation in `MinotariWalletService`
3. Wire up to main app via proxy layer (see step 4 in main integration plan)
4. Add comprehensive error handling
5. Add logging and debugging support

**Integration:**
- See main Minotari integration plan in `docs/NEW_WALLET_TYPES.md`
- Next steps: Create proxy layer, add to configuration, setup nodes

### Building

#### Prerequisites

- Rust toolchain (1.70+)
- Cargo
- cbindgen: `cargo install cbindgen`
- Flutter/Dart SDK

#### Build Rust Library

```bash
cd rust
cargo build --release
```

This will:
1. Compile the Rust library
2. Generate C headers using cbindgen
3. Output platform-specific libraries:
   - Linux: `libminotari_wallet_ffi.so`
   - macOS: `libminotari_wallet_ffi.dylib`
   - Windows: `minotari_wallet_ffi.dll`
   - Android: Will be built by gradle
   - iOS: Will be built by Xcode

#### Generate Dart FFI Bindings

```bash
flutter pub run ffigen
```

This generates `lib/minotari_ffi_bindings.dart` from the C headers.

### Protocol Team Guidance

Based on feedback from the Minotari protocol team:

1. **Don't modify minotari-cli directly** - Keep integration in separate project
2. **Wallet Creation**: Use `init_with_view_key()` after deriving keys from mnemonic
3. **Key Derivation**: See CreateAddress example (main.rs:221-228)
4. **Restore**: Delete DB file and create new wallet
5. **Balance**: Follow pattern in main.rs:426-443

### Resources

- [minotari-cli](https://github.com/tari-project/minotari-cli)
- [Universe Desktop App Integration](https://github.com/tari-project/universe/pull/3050)
- [Cake Wallet Integration Guide](../docs/NEW_WALLET_TYPES.md)

### License

See main Cake Wallet LICENSE file.
